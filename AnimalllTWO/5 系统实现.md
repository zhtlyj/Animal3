# 5 系统实现

## 5.1 开发环境

### 5.1.1 开发工具

系统开发过程中使用的主要开发工具如下：

**（1）代码编辑器**

- **Visual Studio Code (VS Code)**：主要的代码编辑器
  - 版本：最新稳定版
  - 使用插件：ESLint、Prettier、GitLens、React snippets
  - 优势：轻量级、丰富的插件生态、优秀的代码提示

**（2）版本控制工具**

- **Git**：分布式版本控制系统
  - 用于代码版本管理和协作开发
  - 托管平台：GitHub或GitLab

**（3）数据库管理工具**

- **MongoDB Compass**：MongoDB官方图形化管理工具
  - 用于数据库可视化管理
  - 支持数据查询、导入导出、索引管理

**（4）API测试工具**

- **Postman**：API接口测试工具
  - 用于测试RESTful API接口
  - 支持请求发送、响应查看、环境变量管理

**（5）浏览器开发者工具**

- **Chrome DevTools**：Chrome浏览器开发者工具
  - 用于前端调试、性能分析、网络监控

### 5.1.2 技术栈选择

系统技术栈的选择基于项目的实际需求和开发效率考虑。

**（1）前端技术栈选择**

**React 18框架：**
- 选择理由：
  - 组件化开发模式，提高代码复用性
  - 虚拟DOM机制，提升渲染性能
  - 丰富的生态系统和社区支持
  - 使用JavaScript统一前后端语言

**React Router DOM 6：**
- 选择理由：
  - 支持单页应用（SPA）路由管理
  - 声明式路由配置
  - 支持路由保护功能

**React Context API：**
- 选择理由：
  - 轻量级状态管理方案
  - 无需额外依赖库
  - 适合中小型应用

**CSS3：**
- 选择理由：
  - 原生支持，无需编译
  - 支持响应式设计
  - 丰富的样式特性

**（2）后端技术栈选择**

**Node.js：**
- 选择理由：
  - JavaScript运行时环境，前后端语言统一
  - 异步I/O模型，高性能
  - 丰富的npm生态系统

**Express.js 4：**
- 选择理由：
  - 轻量级、灵活的Web框架
  - 中间件机制，易于扩展
  - 广泛的社区支持

**MongoDB：**
- 选择理由：
  - NoSQL文档数据库，灵活的数据模型
  - 适合存储非结构化数据
  - 易于扩展和维护

**Mongoose 7：**
- 选择理由：
  - MongoDB的ODM工具
  - Schema定义，数据验证
  - 支持数据关联和索引管理

**JWT：**
- 选择理由：
  - 无状态身份认证
  - 无需服务器端存储session
  - 适合分布式系统

**bcryptjs：**
- 选择理由：
  - 密码加密哈希算法
  - 安全性高，不可逆
  - 防止彩虹表攻击

### 5.1.3 开发环境配置

**（1）Node.js环境配置**

安装Node.js（建议版本14.0以上）：
```bash
# 检查Node.js版本
node -v

# 检查npm版本
npm -v
```

**（2）MongoDB环境配置**

安装MongoDB数据库：
```bash
# Windows使用Chocolatey安装
choco install mongodb

# macOS使用Homebrew安装
brew install mongodb-community

# Ubuntu/Debian安装
sudo apt-get install mongodb
```

启动MongoDB服务：
```bash
# Windows
net start MongoDB

# macOS/Linux
sudo systemctl start mongod
```

**（3）后端环境配置**

创建后端环境变量文件 `.env`：
```env
# 数据库配置
MONGODB_URI=mongodb://localhost:27017/animal_protection
DB_NAME=animal_protection

# JWT配置
JWT_SECRET=your_super_secret_jwt_key_here_change_in_production
JWT_EXPIRE=7d

# 服务器配置
PORT=5000
NODE_ENV=development

# CORS配置
FRONTEND_URL=http://localhost:3000
```

安装后端依赖：
```bash
cd backend
npm install
```

**（4）前端环境配置**

前端使用Create React App创建，无需额外配置：
```bash
cd frontend
npm install
```

前端环境变量（可选，使用默认配置）：
```env
REACT_APP_API_URL=http://localhost:5000/api
REACT_APP_ENV=development
```

**（5）项目启动**

后端启动：
```bash
cd backend
npm run dev  # 开发模式，使用nodemon自动重启
# 或
npm start    # 生产模式
```

前端启动：
```bash
cd frontend
npm start
```

访问地址：
- 前端：http://localhost:3000
- 后端API：http://localhost:5000

## 5.2 前端界面实现

### 5.2.1 用户界面设计

前端界面采用现代化的设计风格，注重用户体验和视觉美感。

**（1）整体设计风格**

- **色彩方案**：
  - 主色调：温暖的橙色和绿色，体现动物保护的温馨感
  - 辅助色：灰色、白色，用于文字和背景
  - 强调色：红色，用于重要提示和紧急情况

- **布局设计**：
  - 响应式布局，适配PC端和移动端
  - 清晰的导航结构
  - 合理的留白和间距

- **交互设计**：
  - 流畅的页面过渡动画
  - 明确的按钮和链接样式
  - 友好的错误提示和成功反馈

**（2）主要页面设计**

**① 首页（Home）**
- 展示平台统计信息（动物总数、领养成功数、捐赠总额等）
- 动物列表展示（卡片式布局）
- 搜索和筛选功能
- 响应式布局，支持分页

**② 登录/注册页面**
- 简洁的表单设计
- 用户类型选择
- 表单验证提示
- 错误信息展示

**③ 动物详情页面**
- 动物图片轮播展示
- 详细信息展示
- 点赞和收藏功能
- 领养申请按钮

**④ 发布页面**
- 表单式设计
- 图片上传功能
- 富文本编辑器（可选）
- 表单验证

**⑤ 个人中心页面**
- 用户信息展示
- 功能菜单导航
- 我的动物列表
- 我的申请列表

### 5.2.2 核心页面实现

**（1）首页实现**

首页（Home.js）是用户进入平台后看到的第一个页面，展示平台的核心功能和内容。

主要功能实现：
- 使用`useEffect` Hook加载动物列表数据
- 使用`useState` Hook管理页面状态（动物列表、分页信息、筛选条件）
- 调用`animalsAPI.getAnimals()`获取动物列表
- 使用`AnimalCard`组件展示每个动物信息
- 实现搜索和筛选功能
- 实现分页功能

关键代码结构：
```javascript
const Home = () => {
  const [animals, setAnimals] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filters, setFilters] = useState({});
  const [pagination, setPagination] = useState({});

  useEffect(() => {
    loadAnimals();
  }, [filters]);

  const loadAnimals = async () => {
    // 加载动物列表逻辑
  };

  return (
    <div className="home">
      {/* 搜索筛选组件 */}
      {/* 动物列表展示 */}
      {/* 分页组件 */}
    </div>
  );
};
```

**（2）登录页面实现**

登录页面（Login.js）实现用户登录功能。

主要功能实现：
- 表单状态管理（用户ID、密码、用户类型）
- 表单验证（必填项检查）
- 调用`authAPI.login()`进行登录
- 登录成功后保存JWT令牌到LocalStorage
- 更新认证状态（通过Context）
- 根据用户类型跳转到相应页面

关键代码结构：
```javascript
const Login = () => {
  const [formData, setFormData] = useState({
    userId: '',
    password: '',
    userType: '游客'
  });
  const { login } = useAuth();

  const handleSubmit = async (e) => {
    e.preventDefault();
    // 验证表单
    // 调用登录API
    // 处理响应
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* 用户类型选择 */}
      {/* 用户ID输入 */}
      {/* 密码输入 */}
      {/* 提交按钮 */}
    </form>
  );
};
```

**（3）动物详情页面实现**

动物详情页面（AnimalDetailPage.js）展示单个动物的完整信息。

主要功能实现：
- 使用`useParams`获取动物ID
- 调用`animalsAPI.getAnimalById()`获取动物详情
- 图片轮播展示（使用Carousel组件）
- 点赞和收藏功能
- 领养申请按钮（根据用户类型显示）
- 历史记录展示

关键代码结构：
```javascript
const AnimalDetailPage = () => {
  const { id } = useParams();
  const [animal, setAnimal] = useState(null);
  const { user } = useAuth();

  useEffect(() => {
    loadAnimalDetail();
  }, [id]);

  const handleLike = async () => {
    // 点赞逻辑
  };

  const handleAdopt = () => {
    // 跳转到领养申请页面
  };

  return (
    <div className="animal-detail">
      {/* 图片轮播 */}
      {/* 基本信息 */}
      {/* 详细描述 */}
      {/* 互动按钮 */}
      {/* 历史记录 */}
    </div>
  );
};
```

**（4）发布页面实现**

发布页面（Publish.js）允许救助组织发布动物信息。

主要功能实现：
- 表单状态管理（所有动物信息字段）
- 图片上传功能（Base64编码）
- 表单验证（必填项、数据格式）
- 调用`animalsAPI.publishAnimal()`发布动物信息
- 发布成功后跳转到动物详情页

关键代码结构：
```javascript
const Publish = () => {
  const [formData, setFormData] = useState({
    name: '',
    species: '猫',
    status: '可领养',
    city: '',
    // ... 其他字段
  });
  const [images, setImages] = useState([]);

  const handleImageUpload = (e) => {
    // 图片上传处理（Base64编码）
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    // 验证表单
    // 调用发布API
    // 处理响应
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* 表单字段 */}
      {/* 图片上传 */}
      {/* 提交按钮 */}
    </form>
  );
};
```

## 5.3 核心功能实现

### 5.3.1 用户注册登录功能实现

**（1）用户注册功能实现**

用户注册功能的实现涉及前端表单处理和后端数据验证。

**前端实现：**

注册组件（Register.js）实现用户注册表单：
- 表单字段：用户ID、电话、邮箱、密码、确认密码、用户类型
- 前端验证：检查必填项、邮箱格式、密码长度、密码匹配
- API调用：调用`authAPI.register()`发送注册请求
- 响应处理：注册成功后自动登录，跳转到主页

关键代码：
```javascript
const handleSubmit = async (e) => {
  e.preventDefault();
  
  // 前端验证
  if (password !== confirmPassword) {
    showToast('密码和确认密码不匹配', 'error');
    return;
  }

  try {
    const response = await authAPI.register(formData);
    if (response.success) {
      // 保存令牌
      localStorage.setItem('token', response.data.token);
      // 更新认证状态
      login(response.data.user);
      // 跳转
      navigate('/home');
    }
  } catch (error) {
    showToast(error.message, 'error');
  }
};
```

**后端实现：**

注册路由（routes/auth.js）处理注册请求：
- 数据验证：使用express-validator验证请求数据
- 唯一性检查：检查用户ID和邮箱是否已存在
- 密码加密：使用bcryptjs加密密码
- 创建用户：保存用户信息到MongoDB
- 生成JWT：生成JWT令牌返回给前端

关键代码：
```javascript
router.post('/register', [
  body('userId').notEmpty().withMessage('用户ID不能为空'),
  body('email').isEmail().withMessage('邮箱格式无效'),
  body('password').isLength({ min: 6 }).withMessage('密码至少6位'),
], async (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }

  // 检查用户是否已存在
  const existingUser = await User.findOne({ 
    $or: [{ userId: req.body.userId }, { email: req.body.email }] 
  });

  if (existingUser) {
    return res.status(400).json({ message: '用户已存在' });
  }

  // 创建用户
  const user = new User(req.body);
  await user.save();

  // 生成JWT
  const token = jwt.sign({ userId: user._id }, process.env.JWT_SECRET);

  res.json({ success: true, data: { token, user } });
});
```

**（2）用户登录功能实现**

**前端实现：**

登录组件（Login.js）实现登录功能：
- 表单提交：发送用户ID和密码
- API调用：调用`authAPI.login()`进行登录
- 令牌存储：保存JWT令牌到LocalStorage
- 状态更新：更新全局认证状态

**后端实现：**

登录路由验证用户身份：
- 查询用户：根据用户ID查询用户
- 密码验证：使用bcrypt.compare验证密码
- 生成JWT：验证成功后生成JWT令牌
- 更新登录时间：更新用户的lastLogin字段

**（3）认证状态管理**

使用React Context API实现全局认证状态管理：

AuthContext.js实现：
```javascript
const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // 检查LocalStorage中的令牌
    const token = localStorage.getItem('token');
    if (token) {
      // 验证令牌并获取用户信息
      loadUser();
    }
    setLoading(false);
  }, []);

  const login = (userData) => {
    setUser(userData);
  };

  const logout = () => {
    localStorage.removeItem('token');
    setUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, loading }}>
      {children}
    </AuthContext.Provider>
  );
};
```

### 5.3.2 动物管理功能实现

**（1）动物信息发布功能实现**

**前端实现：**

发布页面实现图片上传和表单提交：
- 图片处理：将图片文件转换为Base64编码
- 表单验证：验证必填字段和数据格式
- API调用：调用`animalsAPI.publishAnimal()`发布动物信息

关键代码：
```javascript
const handleImageUpload = (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onloadend = () => {
      setImages([...images, reader.result]); // Base64编码的图片
    };
    reader.readAsDataURL(file);
  }
};

const handleSubmit = async (e) => {
  e.preventDefault();
  const animalData = {
    ...formData,
    cover: images[0] || '',
    media: images
  };
  
  const response = await animalsAPI.publishAnimal(animalData);
  if (response.success) {
    navigate(`/animals/${response.data.animal._id}`);
  }
};
```

**后端实现：**

发布路由处理发布请求：
- 权限验证：检查用户是否为救助组织
- 数据验证：验证必填字段和枚举值
- 创建记录：保存动物信息到MongoDB
- 创建历史：添加发布历史记录

关键代码：
```javascript
router.post('/', auth, requireRole(['救助组织']), [
  body('name').notEmpty(),
  body('species').isIn(['猫', '狗', '兔', '鸟', '爬宠', '其他']),
  body('status').isIn(['可领养', '救助中', '已领养', '紧急求助']),
], async (req, res) => {
  const animal = new Animal({
    ...req.body,
    publisher: req.user._id,
    history: [{
      type: '发布',
      by: req.user._id,
      at: new Date()
    }]
  });

  await animal.save();
  res.json({ success: true, data: { animal } });
});
```

**（2）动物列表查询功能实现**

**前端实现：**

首页实现动物列表查询和筛选：
- 分页查询：使用page和limit参数
- 条件筛选：支持种类、状态、城市筛选
- 关键字搜索：支持按名称搜索

**后端实现：**

查询路由实现灵活的查询功能：
- 构建查询条件：根据请求参数构建MongoDB查询
- 分页处理：使用skip和limit实现分页
- 数据填充：使用populate填充关联数据

关键代码：
```javascript
router.get('/', async (req, res) => {
  const { page = 1, limit = 10, species, status, city, search } = req.query;
  
  const query = { isActive: true };
  if (species) query.species = species;
  if (status) query.status = status;
  if (city) query.city = city;
  if (search) query.name = { $regex: search, $options: 'i' };

  const animals = await Animal.find(query)
    .populate('publisher', 'userId userType profile')
    .sort({ createdAt: -1 })
    .skip((page - 1) * limit)
    .limit(parseInt(limit));

  const total = await Animal.countDocuments(query);

  res.json({
    success: true,
    data: {
      animals,
      pagination: {
        currentPage: parseInt(page),
        totalPages: Math.ceil(total / limit),
        totalCount: total
      }
    }
  });
});
```

**（3）点赞收藏功能实现**

**前端实现：**

动物卡片组件实现点赞和收藏：
- 点击事件：绑定点赞和收藏按钮的点击事件
- API调用：调用`animalsAPI.toggleLike()`和`animalsAPI.toggleFavorite()`
- UI更新：根据响应更新按钮状态和数量

**后端实现：**

点赞路由实现点赞切换逻辑：
- 检查状态：检查用户是否已点赞
- 切换操作：如果已点赞则移除，否则添加
- 返回结果：返回当前点赞状态和总数

关键代码：
```javascript
router.post('/:id/like', auth, async (req, res) => {
  const animal = await Animal.findById(req.params.id);
  const userId = req.user._id;
  
  const isLiked = animal.likes.includes(userId);
  
  if (isLiked) {
    animal.likes = animal.likes.filter(id => id.toString() !== userId.toString());
  } else {
    animal.likes.push(userId);
  }
  
  await animal.save();
  
  res.json({
    success: true,
    data: {
      isLiked: !isLiked,
      likesCount: animal.likes.length
    }
  });
});
```

### 5.3.3 领养管理功能实现

**（1）领养申请提交功能实现**

**前端实现：**

领养申请页面（AdoptionApply.js）实现申请表单：
- 表单字段：个人资料（姓名、电话、地址）、领养动机
- 表单验证：验证必填项
- API调用：调用`animalsAPI.applyAdoption()`提交申请

关键代码：
```javascript
const handleSubmit = async (e) => {
  e.preventDefault();
  
  const applicationData = {
    profile: {
      realName: formData.realName,
      phone: formData.phone,
      address: formData.address
    },
    motivation: formData.motivation
  };

  const response = await animalsAPI.applyAdoption(animalId, applicationData);
  if (response.success) {
    showToast('申请提交成功', 'success');
    navigate(`/animals/${animalId}`);
  }
};
```

**后端实现：**

领养申请路由处理申请提交：
- 权限验证：检查用户是否为领养人
- 状态检查：检查动物状态是否为"可领养"
- 重复检查：检查是否已申请过
- 创建申请：添加到adoptionApplications数组
- 创建历史：添加申请历史记录

关键代码：
```javascript
router.post('/:id/adopt', auth, requireRole(['领养人']), async (req, res) => {
  const animal = await Animal.findById(req.params.id);
  
  if (animal.status !== '可领养') {
    return res.status(400).json({ message: '该动物当前不可领养' });
  }

  // 检查是否已申请
  const existingApp = animal.adoptionApplications.find(
    app => app.applicant.toString() === req.user._id.toString()
  );
  
  if (existingApp) {
    return res.status(400).json({ message: '您已经提交过申请了' });
  }

  // 添加申请
  animal.adoptionApplications.push({
    applicant: req.user._id,
    applicantName: req.body.profile.realName,
    applicantPhone: req.body.profile.phone,
    message: req.body.motivation,
    status: 'pending',
    applicationDate: new Date()
  });

  animal.history.push({
    type: '领养申请',
    by: req.user._id,
    at: new Date()
  });

  await animal.save();
  res.json({ success: true, data: { animal } });
});
```

**（2）领养申请审核功能实现**

**前端实现：**

领养管理页面（AdoptionManagement.js）展示申请列表：
- 查询申请：调用API获取申请的动物列表
- 申请展示：展示每个动物的所有申请
- 审核操作：提供通过/拒绝按钮

**后端实现：**

申请状态更新路由处理审核：
- 权限验证：检查用户是否为动物发布者
- 更新状态：更新申请状态
- 确认领养：如果确认领养，更新动物状态和领养人

关键代码：
```javascript
router.put('/applications/:applicationId', auth, async (req, res) => {
  const { status } = req.body;
  const animal = await Animal.findOne({
    'adoptionApplications._id': req.params.applicationId
  });

  if (animal.publisher.toString() !== req.user._id.toString()) {
    return res.status(403).json({ message: '无权限操作' });
  }

  const application = animal.adoptionApplications.id(req.params.applicationId);
  application.status = status;

  if (status === 'approved') {
    animal.status = '已领养';
    animal.adopter = application.applicant;
    // 拒绝其他申请
    animal.adoptionApplications.forEach(app => {
      if (app._id.toString() !== req.params.applicationId) {
        app.status = 'rejected';
      }
    });
  }

  animal.history.push({
    type: status === 'approved' ? '领养成功' : '申请被拒绝',
    by: req.user._id,
    at: new Date()
  });

  await animal.save();
  res.json({ success: true, data: { animal } });
});
```

### 5.3.4 捐赠管理功能实现

**（1）项目创建功能实现**

**前端实现：**

捐赠页面（Donate.js）实现项目创建表单：
- 表单字段：项目名称、描述、类型、目标金额、图片
- 表单验证：验证必填项和金额格式
- API调用：调用`donationsAPI.createProject()`创建项目

**后端实现：**

项目创建路由处理创建请求：
- 权限验证：检查用户是否为救助组织
- 数据验证：验证必填字段和金额格式
- 创建项目：保存项目信息到MongoDB

**（2）捐赠功能实现**

**前端实现：**

捐赠页面实现捐赠表单：
- 选择项目：从项目列表选择要捐赠的项目
- 填写金额：输入捐赠金额
- 选择支付方式：选择支付方式
- API调用：调用`donationsAPI.donate()`进行捐赠

**后端实现：**

捐赠路由处理捐赠请求：
- 验证数据：验证金额和支付方式
- 创建记录：创建捐赠记录
- 更新项目：更新项目的当前金额
- 检查进度：检查是否达到目标金额，更新项目状态

关键代码：
```javascript
router.post('/', auth, [
  body('amount').isNumeric().withMessage('捐赠金额必须是数字'),
  body('method').isIn(['支付宝', '微信', '银行卡', '加密货币']),
], async (req, res) => {
  const { amount, method, projectId, note } = req.body;

  // 创建捐赠记录
  const donation = new Donation({
    donor: req.user._id,
    amount,
    method,
    project: projectId,
    note,
    status: 'completed'
  });

  await donation.save();

  // 更新项目金额
  if (projectId) {
    const project = await Project.findById(projectId);
    project.currentAmount += amount;
    project.calculateProgress();
    
    if (project.currentAmount >= project.goal) {
      project.status = 'completed';
    }
    
    await project.save();
  }

  res.json({ success: true, data: { donation, project } });
});
```

### 5.3.5 区块链功能实现

**（1）NFT铸造功能实现**

当前系统采用模拟区块链服务实现NFT铸造功能。

**区块链服务（services/blockchain.js）：**
```javascript
export const mintAnimalNFT = async (animalData) => {
  // 模拟NFT铸造
  const tokenId = `NFT-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  const contractAddress = `0x${Math.random().toString(16).substr(2, 40)}`;
  const txHash = `0x${Math.random().toString(16).substr(2, 64)}`;
  const metadataURI = `ipfs://metadata/${tokenId}`;

  return {
    tokenId,
    contractAddress,
    metadataURI,
    txHash
  };
};
```

**后端集成：**

在动物发布时，可选择是否铸造NFT：
```javascript
if (req.body.mintNFT) {
  const nftData = await mintAnimalNFT(req.body);
  animal.nft = nftData;
}
```

**（2）交易记录功能实现**

系统在关键操作时记录交易哈希：

```javascript
const recordTransaction = async (type, data) => {
  const txHash = `0x${Math.random().toString(16).substr(2, 64)}`;
  
  // 保存交易哈希到历史记录
  animal.history.push({
    type,
    tx: txHash,
    at: new Date(),
    details: JSON.stringify(data)
  });
  
  return txHash;
};
```

**（3）未来扩展**

当前为模拟实现，未来可以替换为真实的区块链集成：

- 使用Web3.js或Ethers.js连接以太坊节点
- 部署Solidity智能合约
- 使用IPFS存储元数据
- 实现真实的交易和验证

替换时只需修改区块链服务层，不影响上层业务逻辑。

## 5.4 时序图

系统核心功能的时序图展示了各组件之间的交互顺序。建议使用PlantUML（https://plantuml.com/）绘制时序图。

### 5.4.1 用户注册时序图

用户注册时序图展示了注册过程中前端、后端API、数据库之间的交互：

```
参与者：用户、前端、后端API、MongoDB数据库

用户 -> 前端：填写注册信息
前端 -> 前端：前端验证
前端 -> 后端API：POST /api/auth/register
后端API -> 后端API：数据验证（express-validator）
后端API -> MongoDB：检查用户是否存在
MongoDB -> 后端API：返回查询结果
alt 用户已存在
    后端API -> 前端：返回错误信息
    前端 -> 用户：显示错误提示
else 用户不存在
    后端API -> 后端API：密码加密（bcryptjs）
    后端API -> MongoDB：创建用户记录
    MongoDB -> 后端API：返回创建结果
    后端API -> 后端API：生成JWT令牌
    后端API -> 前端：返回令牌和用户信息
    前端 -> 前端：保存令牌到LocalStorage
    前端 -> 前端：更新认证状态
    前端 -> 用户：跳转到主页
end
```

### 5.4.2 用户登录时序图

用户登录时序图展示了登录过程中各组件之间的交互：

```
参与者：用户、前端、后端API、MongoDB数据库

用户 -> 前端：输入用户ID和密码
前端 -> 前端：前端验证
前端 -> 后端API：POST /api/auth/login
后端API -> MongoDB：查询用户
MongoDB -> 后端API：返回用户信息
后端API -> 后端API：验证密码（bcrypt.compare）
alt 密码错误
    后端API -> 前端：返回错误信息
    前端 -> 用户：显示错误提示
else 密码正确
    后端API -> MongoDB：更新最后登录时间
    后端API -> 后端API：生成JWT令牌
    后端API -> 前端：返回令牌和用户信息
    前端 -> 前端：保存令牌到LocalStorage
    前端 -> 前端：更新认证状态（Context）
    前端 -> 用户：根据用户类型跳转
end
```

### 5.4.3 动物发布时序图

动物发布时序图展示了发布动物信息的过程：

```
参与者：救助组织、前端、后端API、MongoDB数据库

救助组织 -> 前端：填写动物信息并上传图片
前端 -> 前端：图片转换为Base64
前端 -> 前端：表单验证
前端 -> 后端API：POST /api/animals（带JWT令牌）
后端API -> 后端API：验证JWT令牌
后端API -> 后端API：检查用户角色（救助组织）
后端API -> 后端API：数据验证（express-validator）
alt 验证失败
    后端API -> 前端：返回验证错误
    前端 -> 救助组织：显示错误提示
else 验证成功
    后端API -> MongoDB：创建动物记录
    MongoDB -> 后端API：返回创建结果
    后端API -> 前端：返回动物信息
    前端 -> 救助组织：显示发布成功，跳转到详情页
end
```

### 5.4.4 领养申请时序图

领养申请时序图展示了领养申请的完整流程：

```
参与者：领养人、前端、后端API、MongoDB数据库

领养人 -> 前端：查看动物详情
领养人 -> 前端：点击申请领养
前端 -> 前端：显示申请表单
领养人 -> 前端：填写申请信息
前端 -> 前端：表单验证
前端 -> 后端API：POST /api/animals/:id/adopt（带JWT令牌）
后端API -> 后端API：验证JWT令牌
后端API -> 后端API：检查用户角色（领养人）
后端API -> MongoDB：查询动物信息
MongoDB -> 后端API：返回动物信息
后端API -> 后端API：检查动物状态（可领养）
后端API -> 后端API：检查是否已申请
alt 不可申请
    后端API -> 前端：返回错误信息
    前端 -> 领养人：显示错误提示
else 可以申请
    后端API -> MongoDB：添加申请到adoptionApplications
    后端API -> MongoDB：添加历史记录
    MongoDB -> 后端API：返回更新结果
    后端API -> 前端：返回更新后的动物信息
    前端 -> 领养人：显示申请成功提示
end
```

### 5.4.5 捐赠时序图

捐赠时序图展示了用户进行捐赠的过程：

```
参与者：捐赠者、前端、后端API、MongoDB数据库

捐赠者 -> 前端：选择捐赠项目
捐赠者 -> 前端：填写捐赠信息（金额、支付方式）
前端 -> 前端：表单验证
前端 -> 后端API：POST /api/donations（带JWT令牌）
后端API -> 后端API：验证JWT令牌
后端API -> 后端API：数据验证
后端API -> MongoDB：创建捐赠记录
MongoDB -> 后端API：返回创建结果
后端API -> MongoDB：查询项目信息
MongoDB -> 后端API：返回项目信息
后端API -> 后端API：更新项目当前金额
后端API -> 后端API：检查是否达到目标金额
后端API -> MongoDB：更新项目状态（如果达到目标）
MongoDB -> 后端API：返回更新结果
后端API -> 前端：返回捐赠记录和项目信息
前端 -> 捐赠者：显示捐赠成功提示
```

## 5.5 本章小结

本章详细阐述了基于区块链的动物保护公益与领养平台的系统实现过程，包括开发环境配置、前端界面实现和核心功能实现。

**（1）开发环境**

系统开发环境配置完整，包括Node.js、MongoDB、前端和后端的环境配置。技术栈选择合理，前后端统一使用JavaScript，提高了开发效率。

**（2）前端界面实现**

前端采用React框架实现，界面设计现代化，用户体验良好。核心页面包括首页、登录注册、动物详情、发布页面等，都实现了完整的交互功能。

**（3）核心功能实现**

系统核心功能均已实现，包括用户注册登录、动物管理、领养管理、捐赠管理和区块链功能。每个功能都包含前端和后端的完整实现，代码结构清晰，易于维护。

**（4）时序图**

通过时序图清晰展示了系统核心功能的交互流程，有助于理解系统的运行机制。

通过本章的系统实现，验证了系统设计的可行性，为后续的系统测试和部署奠定了基础。
