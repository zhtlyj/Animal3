# 4 系统设计

## 4.1 系统架构设计

基于区块链的动物保护公益与领养平台采用前后端分离的架构设计，整体架构分为三个主要层次：前端展示层、后端服务层和数据存储层。系统架构设计充分考虑了可扩展性、安全性和用户体验。

### 4.1.1 整体架构

系统采用三层架构模式，具体如下：

**（1）前端展示层**

前端采用React 18框架构建单页应用（SPA），主要负责用户界面的展示和用户交互。前端通过RESTful API与后端进行数据交互，使用React Context API进行全局状态管理。前端架构特点包括：

- 组件化开发：采用React组件化思想，将界面拆分为可复用的组件
- 路由管理：使用React Router实现单页应用的路由导航
- 状态管理：使用Context API管理用户认证状态、动物数据状态和捐赠数据状态
- 响应式设计：使用CSS3实现适配不同设备的响应式布局

**（2）后端服务层**

后端采用Node.js + Express框架构建RESTful API服务，主要负责业务逻辑处理、数据验证和权限控制。后端架构特点包括：

- RESTful API设计：遵循REST架构风格，提供标准化的API接口
- 中间件机制：使用Express中间件实现认证、验证、错误处理等功能
- 模块化设计：按功能模块划分路由（认证、动物管理、捐赠管理等）
- JWT认证：采用JWT令牌实现无状态身份认证

**（3）数据存储层**

数据存储层采用MongoDB文档数据库存储业务数据，同时结合区块链技术实现数据的不可篡改性。数据存储层特点包括：

- MongoDB文档存储：使用Mongoose ODM进行数据建模和管理
- 区块链集成：动物信息通过区块链进行NFT铸造和记录
- 数据关联：通过Mongoose的populate机制实现数据关联查询

### 4.1.2 技术架构选型

系统技术架构选型如下：

**前端技术栈：**
- React 18：用户界面构建库
- React Router DOM 6：单页应用路由管理
- React Context API：全局状态管理
- CSS3：样式设计

**后端技术栈：**
- Node.js：JavaScript运行时环境
- Express.js 4：Web应用框架
- MongoDB：NoSQL文档数据库
- Mongoose 7：MongoDB对象建模工具
- JWT：身份认证令牌
- bcryptjs：密码加密
- express-validator：数据验证

**区块链技术：**
- 模拟区块链服务：实现NFT铸造和交易记录
- 未来可扩展：支持以太坊、Web3.js等真实区块链平台

### 4.1.3 系统架构图

系统整体架构图展示了前端、后端和数据库之间的交互关系。前端通过HTTP/HTTPS协议访问后端API，后端通过Mongoose连接MongoDB数据库，同时通过区块链服务实现数据的链上存储和验证。

**架构图绘制说明：**

系统采用分层架构设计，建议使用ProcessOn（https://www.processon.com/）绘制系统架构图。架构图应遵循以下规范：

**（1）分层架构设计**

架构图应包括以下层次（从下到上）：

**① 数据存储层**
- MongoDB数据库
  - 技术：MongoDB、Mongoose 7
  - 存储：User、Animal、Donation、Project集合
- 区块链存储
  - 技术：模拟区块链服务（可扩展为以太坊、IPFS）
  - 存储：NFT元数据、交易哈希、合约地址

**② 后端服务层**
- API服务
  - 技术：Node.js、Express.js 4
  - 功能：RESTful API接口
- 业务逻辑层
  - 技术：Express路由、中间件
  - 功能：认证模块、动物管理、领养管理、捐赠管理
- 认证与安全
  - 技术：JWT、bcryptjs、express-validator
  - 功能：身份认证、密码加密、数据验证

**③ 前端展示层**
- 用户界面
  - 技术：React 18、CSS3
  - 功能：页面展示、用户交互
- 状态管理
  - 技术：React Context API
  - 功能：AuthContext、AnimalsContext、DonationContext
- 路由管理
  - 技术：React Router DOM 6
  - 功能：页面路由、路由保护

**④ 用户层**
- 浏览器客户端
  - 技术：现代浏览器
  - 用户类型：救助组织、领养人、捐赠者

**（2）技术选型标注**

架构图中应在各层明确标注技术选型：
- 前端框架：React 18、React Router DOM 6、React Context API、CSS3
- 后端语言：Node.js
- 后端框架：Express.js 4
- 数据库：MongoDB、Mongoose 7
- 认证技术：JWT、bcryptjs
- 区块链：模拟区块链服务（Web3.js、以太坊、IPFS）

**（3）数据流向**

架构图应清晰展示数据流向：
- 用户请求 → 前端 → HTTP/HTTPS → 后端API
- 后端API → Mongoose → MongoDB数据库
- 后端API → 区块链服务 → 区块链存储
- 数据库响应 → 后端API → HTTP响应 → 前端 → 用户界面

**（4）接口标注**

架构图中应标注主要接口：
- 认证接口：/api/auth/*
- 动物管理接口：/api/animals/*
- 领养管理接口：/api/animals/*/adopt
- 捐赠管理接口：/api/donations/*

## 4.2 系统流程设计

系统流程设计是系统设计的重要组成部分，本节详细描述动物发布流程、领养申请与审核流程以及捐赠与项目发布流程。

### 4.2.1 动物发布流程

动物发布流程是救助组织在平台上发布待救助或待领养动物信息的业务流程。流程设计如下：

**（1）流程步骤**

① 救助组织登录系统，进入动物发布页面

② 填写动物基本信息：
   - 动物名称（必填）
   - 动物种类：猫、狗、兔、鸟、爬宠、其他（必填）
   - 动物状态：可领养、救助中、已领养、紧急求助（必填）
   - 所在城市（必填）
   - 年龄（可选）

③ 上传动物图片：
   - 上传封面图片
   - 上传多张动物照片（可选）

④ 填写详细描述：
   - 动物描述（必填）
   - 健康报告（可选）
   - 领养要求（可选，默认值：需年满18岁，有稳定住所与经济来源，接受回访）

⑤ 提交发布请求，后端验证数据：
   - 验证用户身份（必须是救助组织）
   - 验证必填字段
   - 验证数据格式

⑥ 后端创建动物记录：
   - 保存动物信息到MongoDB数据库
   - 创建发布历史记录
   - 关联发布者信息

⑦ 返回发布结果，前端显示成功提示

**（2）流程图说明**

动物发布流程采用线性流程设计，每个步骤都有明确的前置条件和验证机制。发布成功后，动物信息会显示在平台的动物列表中，供领养人和捐赠者浏览。

**流程图绘制说明：**

建议使用draw.io（https://draw.io/）绘制动物发布流程图，流程图应包括：
- 开始和结束节点
- 矩形框表示操作（如：填写动物信息、上传图片、提交请求等）
- 菱形框表示判断（如：用户身份验证、数据验证等）
- 判断分支上标注条件（是/否，通过/不通过）
- 每个操作都应包括至少一个输入和一个输出
- 流程要与业务紧密相关，体现具体的系统操作

### 4.2.2 领养申请与审核流程

领养申请与审核流程是领养人申请领养动物、救助组织审核申请的完整业务流程。流程设计如下：

**（1）领养申请流程**

① 领养人浏览动物列表，选择感兴趣的动物

② 查看动物详情，包括基本信息、健康报告、领养要求等

③ 确认领养意向，点击"申请领养"按钮

④ 填写领养申请表：
   - 个人资料：真实姓名、联系电话、居住地址等
   - 领养动机：详细说明领养理由和领养后的计划

⑤ 提交领养申请，后端验证：
   - 验证用户身份（必须是领养人）
   - 验证动物状态（必须是"可领养"状态）
   - 验证是否已申请过（防止重复申请）

⑥ 后端处理申请：
   - 将申请添加到动物的adoptionApplications数组
   - 创建领养申请历史记录
   - 关联申请人和动物信息

⑦ 返回申请结果，前端显示申请成功提示

**（2）审核流程**

① 救助组织登录系统，进入"我的动物管理"页面

② 查看发布的动物列表，选择有申请的动物

③ 查看该动物的所有领养申请列表，包括：
   - 申请人信息
   - 申请时间
   - 申请状态（待审核、已通过、已拒绝）
   - 领养动机

④ 审核领养申请：
   - 查看申请人详细信息
   - 评估申请人是否符合领养要求
   - 选择通过或拒绝申请

⑤ 更新申请状态：
   - 如果通过：将申请状态更新为"已通过"，可选择最终领养人
   - 如果拒绝：将申请状态更新为"已拒绝"，记录拒绝原因

⑥ 如果确认领养：
   - 更新动物状态为"已领养"
   - 关联领养人信息
   - 创建领养成功历史记录
   - 其他申请状态自动更新为"已拒绝"

⑦ 通知申请人审核结果

**（3）流程图说明**

领养申请与审核流程采用双向流程设计，领养人提交申请后，需要等待救助组织审核。审核流程支持多个申请人竞争，但最终只能选择一人完成领养。整个流程确保了领养的严肃性和责任感。

**流程图绘制说明：**

建议使用draw.io绘制领养申请与审核流程图，流程图应包括两个子流程：
1. 领养申请流程：浏览动物→查看详情→填写申请表→提交申请→等待审核
2. 审核流程：查看申请列表→选择申请→审核申请→更新状态→确认领养

每个流程图都要包含开始、结束、操作步骤和判断节点。

### 4.2.3 捐赠与项目发布流程

捐赠与项目发布流程包括救助组织创建公益项目、捐赠者进行捐赠的完整业务流程。流程设计如下：

**（1）项目发布流程**

① 救助组织登录系统，进入项目发布页面

② 填写项目基本信息：
   - 项目名称（必填）
   - 项目描述（必填）
   - 项目类型：动物救助、医疗救助、基地建设、日常运营等
   - 目标金额（必填）
   - 项目图片（可选）

③ 提交项目创建请求，后端验证：
   - 验证用户身份（必须是救助组织）
   - 验证必填字段
   - 验证金额格式

④ 后端创建项目记录：
   - 保存项目信息到MongoDB数据库
   - 初始化当前金额为0
   - 设置项目状态为"进行中"
   - 关联创建者信息

⑤ 返回创建结果，前端显示成功提示

**（2）捐赠流程**

① 捐赠者浏览项目列表，选择要捐赠的项目

② 查看项目详情：
   - 项目信息
   - 目标金额和当前金额
   - 捐赠记录
   - 项目进度

③ 点击"立即捐赠"按钮，填写捐赠信息：
   - 捐赠金额（必填）
   - 支付方式：支付宝、微信、银行卡、加密货币（必填）
   - 捐赠留言（可选）
   - 是否匿名捐赠（可选）

④ 提交捐赠请求，后端验证：
   - 验证用户身份（已登录用户）
   - 验证金额格式
   - 验证支付方式

⑤ 后端处理捐赠：
   - 创建捐赠记录
   - 更新项目的当前金额
   - 检查是否达到目标金额，如达到则更新项目状态
   - 生成交易哈希（模拟区块链交易）
   - 关联捐赠者和项目信息

⑥ 返回捐赠结果，前端显示捐赠成功提示

**（3）流程图说明**

捐赠与项目发布流程支持多个项目同时进行，捐赠者可以选择不同项目进行捐赠。系统自动跟踪项目进度，当达到目标金额时更新项目状态。所有捐赠记录都会保存，确保资金流向的透明性和可追溯性。

**流程图绘制说明：**

建议使用draw.io（https://draw.io/）绘制捐赠与项目发布流程图，流程图应遵循以下规范：

**注意事项：**
1. 流程图必须有开始和结束节点
2. 矩形框代表操作，不要出现纯名词（如："登录系统"、"填写项目信息"、"提交创建请求"等）
3. 菱形框代表判断（如："用户身份验证"、"数据验证"、"是否达到目标金额"等），分支上要标注条件（是/否，通过/不通过）
4. 每个操作都应包括至少一个输入、一个输出
5. 流程图的系统操作要和业务紧密相关，避免空洞的描述

流程图应包括两个子流程：
1. 项目发布流程：登录系统→填写项目信息→提交创建请求→验证数据→创建项目→返回结果
2. 捐赠流程：浏览项目→查看详情→填写捐赠信息→提交捐赠→更新金额→检查进度→返回结果

流程图要体现业务逻辑的完整性和数据流向。

### 4.2.4 流程图汇总说明

系统核心业务流程需要绘制以下流程图（建议使用draw.io绘制）：

1. **动物发布流程图**：展示救助组织发布动物信息的完整流程
2. **领养申请流程图**：展示领养人提交领养申请的完整流程
3. **领养审核流程图**：展示救助组织审核领养申请的完整流程
4. **项目发布流程图**：展示救助组织创建捐赠项目的完整流程
5. **捐赠流程图**：展示用户进行捐赠的完整流程

每个流程图都应包含：
- 开始和结束节点
- 具体的操作步骤（矩形）
- 判断节点（菱形）和条件标注
- 清晰的数据流向

## 4.3 功能模块设计

系统功能模块设计将系统按照业务功能划分为不同的模块，每个模块负责特定的业务功能。本节详细描述各个功能模块的设计。

### 4.3.0 功能模块图

系统功能模块图展示了系统的整体功能划分和各模块之间的关系。

**功能模块图绘制说明：**

建议使用ProcessOn（https://www.processon.com/）绘制功能模块图，功能模块图应包括以下模块：

**（1）用户管理模块**
- 用户注册
- 用户登录
- 用户信息管理
- 权限控制

**（2）动物管理模块**
- 动物信息发布
- 动物信息查询
- 动物信息更新
- 动物信息删除
- 点赞收藏功能

**（3）领养管理模块**
- 领养申请提交
- 领养申请查询
- 领养申请审核
- 领养后管理

**（4）捐赠管理模块**
- 项目创建
- 项目查询
- 捐赠功能
- 捐赠记录查询
- 统计功能

**（5）区块链模块**
- NFT铸造
- 交易记录
- 数据验证

功能模块图应清晰展示各模块之间的关系和数据交互。

### 4.3.1 用户注册登录模块设计

用户注册登录模块是系统的入口模块，负责用户的身份认证和授权管理。

**（1）用户类型**

系统支持四种用户类型：
- 游客：默认用户类型，可以浏览平台功能
- 救助组织：可以发布动物信息、创建捐赠项目
- 领养人：可以申请领养动物
- 捐赠者：可以进行捐赠

**（2）注册功能**

注册功能包括以下步骤：
- 选择用户类型
- 填写用户ID（唯一标识）
- 填写电话号码
- 填写邮箱地址
- 设置密码（至少6位）
- 确认密码
- 提交注册请求

后端验证：
- 用户ID唯一性检查
- 邮箱唯一性检查
- 密码强度验证
- 数据格式验证

注册成功后：
- 密码使用bcryptjs加密存储
- 创建用户记录到MongoDB
- 返回注册成功信息

**（3）登录功能**

登录功能包括以下步骤：
- 选择用户类型
- 输入用户ID
- 输入密码
- 提交登录请求

后端验证：
- 验证用户是否存在
- 验证密码是否正确
- 验证用户是否激活

登录成功后：
- 生成JWT令牌
- 返回令牌和用户信息
- 前端存储令牌到LocalStorage

**（4）权限控制**

系统采用基于角色的访问控制（RBAC）：
- 游客：可以浏览动物列表、项目列表
- 救助组织：可以发布动物、创建项目、审核领养申请
- 领养人：可以申请领养、查看我的申请
- 捐赠者：可以进行捐赠、查看捐赠历史

### 4.3.2 动物管理模块设计

动物管理模块是系统的核心模块，负责动物信息的发布、查询、更新和管理。

**（1）动物信息发布**

动物信息发布功能允许救助组织发布动物信息，包括：
- 基本信息：名称、种类、状态、城市、年龄
- 图片信息：封面图片、多张照片
- 详细信息：描述、健康报告、领养要求
- 区块链信息：NFT铸造（可选）

**（2）动物信息查询**

动物信息查询支持多种查询方式：
- 列表查询：分页查询所有动物
- 条件筛选：按种类、状态、城市筛选
- 关键字搜索：按动物名称搜索
- 详情查询：查询单个动物的完整信息

**（3）动物信息更新**

动物信息更新功能允许发布者更新已发布的动物信息：
- 更新基本信息
- 更新图片
- 更新描述
- 更新状态（如从"救助中"改为"可领养"）

**（4）动物信息管理**

动物信息管理包括：
- 点赞功能：用户可以对动物点赞
- 收藏功能：用户可以收藏感兴趣的动物
- 生活照上传：领养后可以上传生活照
- 历史记录：记录动物的所有状态变更和操作历史

**（5）软删除机制**

系统采用软删除机制，删除动物时：
- 设置isActive字段为false
- 保留历史数据
- 不在列表中显示，但可以通过ID查询

### 4.3.3 领养管理模块设计

领养管理模块负责领养申请的提交、审核和管理。

**（1）领养申请提交**

领养申请提交功能允许领养人提交领养申请：
- 选择要领养的动物
- 填写个人资料
- 填写领养动机
- 提交申请

**（2）申请审核**

申请审核功能允许救助组织审核领养申请：
- 查看所有申请列表
- 查看申请人详细信息
- 审核申请（通过/拒绝）
- 选择最终领养人
- 更新动物状态为"已领养"

**（3）申请管理**

申请管理功能包括：
- 我的申请（领养人）：查看自己提交的所有申请
- 我的动物的申请（救助组织）：查看自己发布的动物的所有申请
- 申请状态跟踪：待审核、已通过、已拒绝、已领养

**（4）领养后管理**

领养后管理功能包括：
- 上传生活照
- 更新动物状态
- 查看领养历史

### 4.3.4 捐赠管理模块设计

捐赠管理模块负责公益项目的创建、捐赠和管理。

**（1）项目创建**

项目创建功能允许救助组织创建公益项目：
- 填写项目信息
- 设置目标金额
- 选择项目类型
- 上传项目图片

**（2）项目查询**

项目查询功能包括：
- 项目列表查询：分页查询所有项目
- 项目详情查询：查询单个项目的完整信息
- 项目筛选：按类型、状态筛选

**（3）捐赠功能**

捐赠功能允许用户进行捐赠：
- 选择捐赠项目
- 输入捐赠金额
- 选择支付方式
- 填写捐赠留言
- 提交捐赠

**（4）捐赠管理**

捐赠管理功能包括：
- 捐赠历史查询：查看所有捐赠记录
- 统计信息：查看捐赠统计
- 项目进度跟踪：查看项目进度

### 4.3.5 区块链模块设计

区块链模块负责将动物信息上链，实现数据的不可篡改和透明性。

**功能模块图说明：**

建议使用ProcessOn绘制系统功能模块图，功能模块图应展示：
- 用户注册登录模块
- 动物管理模块
- 领养管理模块
- 捐赠管理模块
- 区块链模块

各模块之间的关系和调用关系，以及每个模块的主要功能子模块。

**（1）NFT铸造**

NFT铸造功能将动物信息铸造成NFT：
- 生成动物NFT元数据
- 铸造NFT到区块链
- 获取Token ID和合约地址
- 保存交易哈希
- 关联NFT信息到动物记录

**（2）交易记录**

交易记录功能记录关键操作到区块链：
- 领养申请上链
- 领养成功上链
- 捐赠交易上链
- 状态变更上链

**（3）数据验证**

数据验证功能通过区块链验证数据真实性：
- 验证NFT所有权
- 验证交易真实性
- 验证数据完整性

**（4）区块链服务设计**

当前系统采用模拟区块链服务，主要功能包括：
- 模拟NFT铸造：生成Token ID和合约地址
- 模拟交易哈希：生成交易哈希值
- 模拟合约地址：生成合约地址

未来可以扩展为真实的区块链集成：
- 使用Web3.js或Ethers.js连接以太坊
- 部署Solidity智能合约
- 集成IPFS存储元数据

## 4.4 数据库设计

数据库设计是系统设计的重要环节，本节详细描述数据库ER图、数据表设计和区块链设计。

### 4.4.1 数据库ER图

系统数据库ER图展示了各个实体之间的关系。主要实体包括：

**ER图绘制说明：**

建议使用ProcessOn绘制数据库ER图，ER图应遵循以下规范：
- 矩形框代表实体（User、Animal、Donation、Project）
- 椭圆代表属性（实体的各个字段）
- 菱形代表关联（实体之间的关系）
- 实体之间体现关联，关联要标注数量（1对1、1对多、多对多）
- 使用连线连接实体和属性，以及实体之间的关系

**（1）User（用户）实体**

User实体存储用户的基本信息和认证信息，包括：
- 用户ID（唯一标识）
- 电话号码
- 邮箱地址
- 密码（加密存储）
- 用户类型
- 个人资料（姓名、头像、简介、地址等）
- 钱包地址（区块链地址）
- 组织信息（救助组织专用）
- 激活状态

**（2）Animal（动物）实体**

Animal实体存储动物的完整信息，包括：
- 基本信息：名称、种类、状态、城市、年龄
- 图片信息：封面、照片数组
- 描述信息：描述、健康报告、领养要求
- 关联信息：发布者、领养者
- 互动信息：点赞列表、收藏列表
- 申请信息：领养申请数组
- 历史记录：操作历史数组
- 生活照：领养后照片数组
- 区块链信息：NFT信息

**（3）Donation（捐赠）实体**

Donation实体存储捐赠记录，包括：
- 捐赠者信息（关联User）
- 捐赠金额
- 支付方式
- 捐赠时间
- 关联项目（关联Project，可选）
- 关联动物（关联Animal，可选）
- 交易哈希（区块链交易）
- 捐赠留言
- 是否匿名

**（4）Project（项目）实体**

Project实体存储公益项目信息，包括：
- 项目名称
- 项目描述
- 项目类型
- 目标金额
- 当前金额
- 项目状态（进行中、已完成、已关闭）
- 创建者信息（关联User）
- 项目图片
- 创建时间

**实体关系：**

- User与Animal：一对多关系（一个用户可发布多个动物，一个动物只能由一个用户发布）
- User与Animal：多对一关系（多个用户可申请领养，一个动物只能被一个用户领养）
- User与Donation：一对多关系（一个用户可进行多次捐赠）
- User与Project：一对多关系（一个救助组织可创建多个项目）
- Project与Donation：一对多关系（一个项目可有多次捐赠）
- Animal与Donation：多对一关系（多个捐赠可关联到同一个动物）

**ER图绘制说明：**

建议使用ProcessOn（https://www.processon.com/）绘制数据库ER图，ER图应遵循以下规范：

**注意事项：**
1. 矩形代表实体（User、Animal、Donation、Project）
2. 椭圆代表属性（如userId、name、email等）
3. 菱形代表关联（发布、领养、捐赠、创建等）
4. 实体之间体现关联，关联要标注数量（1:1、1:N、N:M）
5. 主键用下划线标识，外键标注FK

**ER图应包括：**
- User实体及其所有属性
- Animal实体及其所有属性
- Donation实体及其所有属性
- Project实体及其所有属性
- 实体之间的关联关系（发布、领养、捐赠、创建）及数量标注
- 关联的属性（如果有）

### 4.4.2 数据表设计

数据表设计基于MongoDB文档数据库，采用Mongoose Schema定义。本节详细描述各个数据表的结构。

**数据表设计说明：**

以下展示主要数据表的Schema定义，建议在论文中以表格形式呈现数据表结构，包括字段名、数据类型、约束条件、说明等。

**数据表绘制要求：**

在论文中应以表格形式展示各数据表的详细结构，表格应包括以下列：
- 字段名：数据库字段名称
- 数据类型：字段的数据类型（String、Number、Date、Boolean、ObjectId等）
- 约束条件：是否必填、是否唯一、默认值、枚举值等
- 说明：字段的业务含义

建议展示以下数据表：
1. User表结构
2. Animal表结构
3. Donation表结构
4. Project表结构

**（1）User集合设计**

User集合Schema定义如下：

```javascript
{
  userId: String,          // 用户ID，唯一，必填
  phone: String,           // 电话号码，必填
  email: String,           // 邮箱，唯一，必填
  password: String,        // 密码，加密存储，必填
  userType: String,        // 用户类型，枚举值，必填
  avatar: String,          // 头像URL
  organization: String,    // 组织名称（救助组织）
  address: String,         // 地址
  description: String,     // 简介
  website: String,         // 网站
  contactPerson: String,   // 联系人（救助组织）
  establishedDate: Date,   // 成立日期（救助组织）
  walletAddress: String,   // 钱包地址
  profile: {               // 个人资料
    name: String,
    avatar: String,
    bio: String,
    location: String
  },
  isActive: Boolean,       // 激活状态，默认true
  lastLogin: Date,         // 最后登录时间
  createdAt: Date,         // 创建时间
  updatedAt: Date          // 更新时间
}
```

索引设计：
- userId：唯一索引
- email：唯一索引
- userType：普通索引

**（2）Animal集合设计**

Animal集合Schema定义如下：

```javascript
{
  name: String,                    // 动物名称，必填
  species: String,                 // 种类，枚举值，必填
  status: String,                  // 状态，枚举值，必填
  city: String,                    // 城市，必填
  age: String,                     // 年龄
  cover: String,                   // 封面图片URL
  media: [String],                 // 照片数组
  description: String,             // 描述，必填
  healthReport: String,            // 健康报告
  adoptionRequirements: String,    // 领养要求
  nft: {                           // NFT信息
    tokenId: String,
    contractAddress: String,
    metadataURI: String,
    txHash: String
  },
  publisher: ObjectId,             // 发布者ID，关联User，必填
  adopter: ObjectId,               // 领养者ID，关联User
  history: [{                      // 历史记录数组
    type: String,                  // 操作类型
    by: ObjectId,                  // 操作者ID
    at: Date,                      // 操作时间
    tx: String,                    // 交易哈希
    matchedOrgId: String,          // 匹配的组织ID
    details: String                // 详细信息
  }],
  likes: [ObjectId],               // 点赞用户ID数组
  favorites: [ObjectId],           // 收藏用户ID数组
  lifePhotos: [{                   // 生活照数组
    url: String,
    description: String,
    uploadedAt: Date
  }],
  adoptionApplications: [{         // 领养申请数组
    applicant: ObjectId,           // 申请人ID
    applicantName: String,         // 申请人姓名
    applicantPhone: String,        // 申请人电话
    applicantEmail: String,        // 申请人邮箱
    message: String,               // 申请留言
    status: String,                // 申请状态
    applicationDate: Date          // 申请时间
  }],
  isActive: Boolean,               // 激活状态，默认true
  createdAt: Date,                 // 创建时间
  updatedAt: Date                  // 更新时间
}
```

索引设计：
- publisher：普通索引
- adopter：普通索引
- species：普通索引
- status：普通索引
- city：普通索引
- createdAt：普通索引（用于排序）

**（3）Donation集合设计**

Donation集合Schema定义如下：

```javascript
{
  donor: ObjectId,                 // 捐赠者ID，关联User，必填
  amount: Number,                  // 捐赠金额，必填
  method: String,                  // 支付方式，枚举值，必填
  projectId: ObjectId,             // 项目ID，关联Project
  animalId: ObjectId,              // 动物ID，关联Animal
  txHash: String,                  // 交易哈希
  note: String,                    // 捐赠留言
  isAnonymous: Boolean,            // 是否匿名，默认false
  createdAt: Date,                 // 创建时间
  updatedAt: Date                  // 更新时间
}
```

索引设计：
- donor：普通索引
- projectId：普通索引
- animalId：普通索引
- createdAt：普通索引（用于排序）

**（4）Project集合设计**

Project集合Schema定义如下：

```javascript
{
  name: String,                    // 项目名称，必填
  description: String,             // 项目描述，必填
  type: String,                    // 项目类型，枚举值，必填
  targetAmount: Number,            // 目标金额，必填
  currentAmount: Number,           // 当前金额，默认0
  status: String,                  // 项目状态，枚举值，默认"进行中"
  creator: ObjectId,               // 创建者ID，关联User，必填
  image: String,                   // 项目图片URL
  createdAt: Date,                 // 创建时间
  updatedAt: Date                  // 更新时间
}
```

索引设计：
- creator：普通索引
- status：普通索引
- type：普通索引
- createdAt：普通索引（用于排序）

### 4.4.3 区块链设计

区块链设计是系统创新的重要组成部分，通过区块链技术实现数据的不可篡改和透明性。

**区块链设计图说明：**

建议使用ProcessOn绘制区块链设计图，设计图应展示：
- 区块链整体架构
- NFT铸造流程
- 交易记录流程
- 数据验证流程
- 智能合约设计（未来扩展）
- 区块链与MongoDB的交互关系

设计图要清晰展示区块链技术在系统中的位置和作用。

**（1）NFT设计**

每个动物信息可以铸造成一个NFT（Non-Fungible Token），NFT作为动物在区块链上的唯一身份标识。NFT设计包括：

- Token ID：NFT的唯一标识符
- Contract Address：NFT合约地址
- Metadata URI：NFT元数据的存储地址（IPFS）
- Transaction Hash：铸造NFT的交易哈希

NFT元数据包括：
- 动物基本信息（名称、种类、年龄等）
- 动物图片（IPFS地址）
- 健康报告
- 发布者信息
- 发布时间

**（2）交易记录设计**

系统将关键操作记录到区块链上，包括：

- 动物发布交易：记录动物信息发布到区块链
- 领养申请交易：记录领养申请提交到区块链
- 领养成功交易：记录领养成功到区块链
- 捐赠交易：记录捐赠到区块链
- 状态变更交易：记录动物状态变更到区块链

每个交易记录包括：
- 交易哈希：区块链交易的唯一标识
- 交易类型：操作类型
- 交易时间：交易发生时间
- 交易详情：JSON格式的详细信息

**（3）智能合约设计**

智能合约设计（未来扩展）包括以下功能：

- 动物NFT合约（AnimalNFT）：
  - mint函数：铸造动物NFT
  - transfer函数：转移NFT所有权
  - getTokenInfo函数：查询NFT信息
  
- 领养管理合约（AdoptionContract）：
  - submitApplication函数：提交领养申请
  - approveApplication函数：审核领养申请
  - completeAdoption函数：完成领养

- 捐赠管理合约（DonationContract）：
  - createProject函数：创建捐赠项目
  - donate函数：进行捐赠
  - withdraw函数：提取资金（仅项目创建者）

**（4）区块链存储设计**

系统采用混合存储方案：
- 链上存储：关键信息（NFT ID、交易哈希、状态）存储在区块链上
- 链下存储：详细信息（图片、描述、健康报告）存储在IPFS或MongoDB

这种设计平衡了存储成本和查询效率，既保证了数据的不可篡改性，又保证了系统的性能。

**（5）当前实现**

当前系统采用模拟区块链服务实现区块链功能：
- 模拟NFT铸造：生成Token ID和合约地址
- 模拟交易哈希：生成交易哈希值
- 模拟合约地址：生成合约地址

未来可以无缝替换为真实的区块链集成，只需替换区块链服务层，不影响上层业务逻辑。

**区块链设计图绘制说明：**

建议使用ProcessOn（https://www.processon.com/）绘制区块链设计图，区块链设计图应包括以下内容：

**（1）区块链架构层次**
- 应用层：动物保护平台应用
- 智能合约层：AnimalNFT合约、AdoptionContract合约、DonationContract合约
- 区块链网络层：以太坊网络（当前为模拟）
- 存储层：IPFS（元数据存储）、链上存储（关键数据）

**（2）NFT铸造流程**
- 动物信息提交
- 生成NFT元数据
- 调用智能合约铸造NFT
- 存储元数据到IPFS
- 返回Token ID和交易哈希

**（3）交易记录流程**
- 业务操作触发（领养申请、捐赠等）
- 生成交易数据
- 调用智能合约记录交易
- 返回交易哈希
- 存储交易哈希到数据库

**（4）数据验证流程**
- 查询链上数据
- 验证NFT所有权
- 验证交易真实性
- 返回验证结果

区块链设计图应清晰展示区块链与业务系统的集成方式、数据流向和交互过程。

## 4.5 接口设计

接口设计定义了前后端交互的API规范，本节详细描述各个模块的接口设计。

### 4.5.1 认证接口设计

认证接口负责用户注册、登录和身份验证。

**（1）用户注册接口**

```
POST /api/auth/register

请求体：
{
  "userId": "string",        // 用户ID，必填
  "phone": "string",         // 电话号码，必填
  "email": "string",         // 邮箱，必填
  "password": "string",      // 密码，必填，至少6位
  "userType": "string"       // 用户类型，必填，枚举值
}

响应：
{
  "success": true,
  "message": "注册成功",
  "data": {
    "token": "string",       // JWT令牌
    "user": {                // 用户信息
      "userId": "string",
      "email": "string",
      "userType": "string"
    }
  }
}
```

**（2）用户登录接口**

```
POST /api/auth/login

请求体：
{
  "userId": "string",        // 用户ID，必填
  "password": "string",      // 密码，必填
  "userType": "string"       // 用户类型，必填
}

响应：
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "string",       // JWT令牌
    "user": {                // 用户信息
      "_id": "string",
      "userId": "string",
      "email": "string",
      "userType": "string",
      "profile": {}
    }
  }
}
```

**（3）获取当前用户信息接口**

```
GET /api/auth/me

请求头：
Authorization: Bearer {token}

响应：
{
  "success": true,
  "data": {
    "user": {                // 完整用户信息
      "_id": "string",
      "userId": "string",
      "email": "string",
      "userType": "string",
      "profile": {},
      ...
    }
  }
}
```

**（4）更新用户资料接口**

```
PUT /api/auth/profile

请求头：
Authorization: Bearer {token}

请求体：
{
  "profile": {               // 个人资料
    "name": "string",
    "avatar": "string",
    "bio": "string",
    "location": "string"
  },
  "organization": "string",  // 组织名称（可选）
  "address": "string",       // 地址（可选）
  "description": "string"    // 简介（可选）
}

响应：
{
  "success": true,
  "message": "资料更新成功",
  "data": {
    "user": {}
  }
}
```

### 4.5.2 动物管理接口设计

动物管理接口负责动物信息的增删改查和互动功能。

**（1）获取动物列表接口**

```
GET /api/animals

查询参数：
- page: number          // 页码，默认1
- limit: number         // 每页数量，默认10
- species: string       // 种类筛选（可选）
- status: string        // 状态筛选（可选）
- city: string          // 城市筛选（可选）
- search: string        // 关键字搜索（可选）

响应：
{
  "success": true,
  "data": {
    "animals": [],       // 动物列表
    "pagination": {
      "currentPage": 1,
      "totalPages": 10,
      "totalCount": 100
    }
  }
}
```

**（2）获取动物详情接口**

```
GET /api/animals/:id

响应：
{
  "success": true,
  "data": {
    "animal": {          // 完整动物信息
      "_id": "string",
      "name": "string",
      "species": "string",
      "status": "string",
      "city": "string",
      "description": "string",
      "publisher": {},   // 发布者信息（populate）
      "adopter": {},     // 领养者信息（populate）
      "history": [],
      "likes": [],
      "favorites": [],
      ...
    }
  }
}
```

**（3）发布动物信息接口**

```
POST /api/animals

请求头：
Authorization: Bearer {token}

请求体：
{
  "name": "string",              // 必填
  "species": "string",           // 必填，枚举值
  "status": "string",            // 必填，枚举值
  "city": "string",              // 必填
  "age": "string",               // 可选
  "cover": "string",             // 可选，图片URL
  "media": ["string"],           // 可选，图片URL数组
  "description": "string",       // 必填
  "healthReport": "string",      // 可选
  "adoptionRequirements": "string" // 可选
}

响应：
{
  "success": true,
  "message": "动物信息发布成功",
  "data": {
    "animal": {}
  }
}
```

**（4）更新动物信息接口**

```
PUT /api/animals/:id

请求头：
Authorization: Bearer {token}

请求体：
{
  // 同发布接口，所有字段可选
}

响应：
{
  "success": true,
  "message": "动物信息更新成功",
  "data": {
    "animal": {}
  }
}
```

**（5）删除动物信息接口**

```
DELETE /api/animals/:id

请求头：
Authorization: Bearer {token}

响应：
{
  "success": true,
  "message": "动物信息删除成功"
}
```

**（6）点赞/取消点赞接口**

```
POST /api/animals/:id/like

请求头：
Authorization: Bearer {token}

响应：
{
  "success": true,
  "message": "操作成功",
  "data": {
    "isLiked": true,     // 当前是否已点赞
    "likesCount": 10     // 点赞总数
  }
}
```

**（7）收藏/取消收藏接口**

```
POST /api/animals/:id/favorite

请求头：
Authorization: Bearer {token}

响应：
{
  "success": true,
  "message": "操作成功",
  "data": {
    "isFavorited": true, // 当前是否已收藏
    "favoritesCount": 5  // 收藏总数
  }
}
```

### 4.5.3 领养管理接口设计

领养管理接口负责领养申请的提交、查询和管理。

**（1）申请领养接口**

```
POST /api/animals/:id/adopt

请求头：
Authorization: Bearer {token}

请求体：
{
  "profile": {           // 个人资料，必填
    "realName": "string",
    "phone": "string",
    "address": "string"
  },
  "motivation": "string" // 领养动机，必填
}

响应：
{
  "success": true,
  "message": "领养申请提交成功",
  "data": {
    "animal": {}
  }
}
```

**（2）获取领养申请列表接口（救助组织）**

```
GET /api/animals/applications

请求头：
Authorization: Bearer {token}

查询参数：
- animalId: string      // 动物ID（可选）

响应：
{
  "success": true,
  "data": {
    "applications": []   // 申请列表
  }
}
```

**（3）获取我的申请接口（领养人）**

```
GET /api/animals/my-applications

请求头：
Authorization: Bearer {token}

响应：
{
  "success": true,
  "data": {
    "applications": []   // 我的申请列表
  }
}
```

**（4）更新申请状态接口**

```
PUT /api/animals/applications/:applicationId

请求头：
Authorization: Bearer {token}

请求体：
{
  "status": "string"     // 申请状态：pending, approved, rejected
}

响应：
{
  "success": true,
  "message": "申请状态更新成功",
  "data": {
    "animal": {}
  }
}
```

### 4.5.4 捐赠管理接口设计

捐赠管理接口负责项目创建、查询和捐赠功能。

**（1）获取项目列表接口**

```
GET /api/donations/projects

查询参数：
- page: number          // 页码
- limit: number         // 每页数量
- type: string          // 项目类型筛选（可选）
- status: string        // 项目状态筛选（可选）

响应：
{
  "success": true,
  "data": {
    "projects": [],
    "pagination": {}
  }
}
```

**（2）获取项目详情接口**

```
GET /api/donations/projects/:id

响应：
{
  "success": true,
  "data": {
    "project": {         // 完整项目信息
      "_id": "string",
      "name": "string",
      "description": "string",
      "type": "string",
      "targetAmount": 10000,
      "currentAmount": 5000,
      "status": "string",
      "creator": {},     // 创建者信息（populate）
      "progress": 50     // 进度百分比
    }
  }
}
```

**（3）创建项目接口**

```
POST /api/donations/projects

请求头：
Authorization: Bearer {token}

请求体：
{
  "name": "string",          // 必填
  "description": "string",   // 必填
  "type": "string",          // 必填，枚举值
  "targetAmount": number,    // 必填
  "image": "string"          // 可选，图片URL
}

响应：
{
  "success": true,
  "message": "项目创建成功",
  "data": {
    "project": {}
  }
}
```

**（4）进行捐赠接口**

```
POST /api/donations

请求头：
Authorization: Bearer {token}

请求体：
{
  "amount": number,          // 必填，捐赠金额
  "method": "string",        // 必填，支付方式，枚举值
  "projectId": "string",     // 可选，项目ID
  "animalId": "string",      // 可选，动物ID
  "note": "string",          // 可选，捐赠留言
  "isAnonymous": boolean     // 可选，是否匿名，默认false
}

响应：
{
  "success": true,
  "message": "捐赠成功",
  "data": {
    "donation": {},
    "project": {}            // 更新后的项目信息
  }
}
```

**（5）获取捐赠历史接口**

```
GET /api/donations/history

请求头：
Authorization: Bearer {token}

查询参数：
- page: number
- limit: number

响应：
{
  "success": true,
  "data": {
    "donations": [],
    "pagination": {}
  }
}
```

**（6）获取统计信息接口**

```
GET /api/donations/stats

响应：
{
  "success": true,
  "data": {
    "totalAmount": 100000,     // 总捐赠金额
    "totalDonations": 500,     // 总捐赠次数
    "activeProjects": 10,      // 进行中项目数
    "completedProjects": 5     // 已完成项目数
  }
}
```

## 4.6 详细设计

详细设计是在功能模块设计的基础上，对各个模块进行更加详细的设计，包括具体的实现方案、数据流和交互逻辑。

### 4.6.1 用户注册登录模块详细设计

**（1）注册流程详细设计**

用户注册流程的详细设计如下：

① 前端显示注册表单，用户选择用户类型并填写信息

② 前端进行客户端验证：
   - 用户ID格式验证
   - 邮箱格式验证
   - 密码强度验证（至少6位）
   - 确认密码匹配验证

③ 前端发送注册请求到后端API

④ 后端接收请求，使用express-validator进行服务端验证：
   - 验证必填字段
   - 验证邮箱格式
   - 验证用户ID格式
   - 验证密码长度

⑤ 后端检查用户ID和邮箱的唯一性：
   - 查询MongoDB数据库
   - 如果已存在，返回错误信息

⑥ 后端使用bcryptjs加密密码：
   - 生成salt
   - 对密码进行哈希加密

⑦ 后端创建用户记录：
   - 创建User对象
   - 设置默认值（isActive=true）
   - 保存到MongoDB

⑧ 后端生成JWT令牌：
   - 包含用户ID和用户类型
   - 设置过期时间（7天）

⑨ 后端返回响应：
   - 返回JWT令牌和用户基本信息

⑩ 前端接收响应：
   - 存储JWT令牌到LocalStorage
   - 更新认证状态
   - 跳转到主页或仪表板

**（2）登录流程详细设计**

用户登录流程的详细设计如下：

① 前端显示登录表单，用户输入用户ID和密码

② 前端发送登录请求到后端API

③ 后端接收请求，进行数据验证

④ 后端查询用户：
   - 根据用户ID查询MongoDB
   - 检查用户是否存在
   - 检查用户是否激活（isActive=true）

⑤ 后端验证密码：
   - 使用bcrypt.compare比较密码
   - 如果密码不匹配，返回错误

⑥ 后端更新最后登录时间

⑦ 后端生成JWT令牌

⑧ 后端返回响应：
   - 返回JWT令牌和用户信息

⑨ 前端接收响应：
   - 存储JWT令牌
   - 更新认证状态
   - 根据用户类型跳转到相应页面

**（3）权限控制详细设计**

权限控制采用中间件机制，详细设计如下：

① 前端请求需要认证的API时，在请求头中添加JWT令牌：
   ```
   Authorization: Bearer {token}
   ```

② 后端auth中间件拦截请求：
   - 从请求头中提取JWT令牌
   - 验证令牌的有效性
   - 解码令牌获取用户信息
   - 将用户信息附加到请求对象（req.user）

③ 后端requireRole中间件检查用户角色：
   - 读取req.user.userType
   - 检查是否在允许的角色列表中
   - 如果不符合，返回403错误

④ 如果认证和授权都通过，请求继续处理

### 4.6.2 动物管理模块详细设计

**（1）动物发布详细设计**

动物发布的详细设计如下：

① 前端显示发布表单，救助组织填写动物信息

② 前端处理图片上传：
   - 用户选择图片文件
   - 将图片转换为Base64编码
   - 或者上传到服务器获取URL

③ 前端发送发布请求到后端API

④ 后端验证用户身份：
   - 检查是否已登录
   - 检查用户类型是否为"救助组织"

⑤ 后端使用express-validator验证数据：
   - 验证必填字段（name, species, status, city, description）
   - 验证枚举值（species, status）
   - 验证数据格式

⑥ 后端创建Animal对象：
   - 设置基本信息
   - 设置发布者ID（req.user._id）
   - 创建初始历史记录（type: '发布'）

⑦ 后端保存到MongoDB：
   - 调用animal.save()
   - 使用populate填充发布者信息

⑧ 后端返回响应，前端显示成功提示

**（2）动物查询详细设计**

动物查询的详细设计如下：

① 前端发送查询请求，包含查询参数（分页、筛选、搜索）

② 后端构建查询条件：
   - 基础查询：isActive=true
   - 种类筛选：species=xxx
   - 状态筛选：status=xxx
   - 城市筛选：city=xxx
   - 关键字搜索：name包含关键字

③ 后端执行查询：
   - 使用find()查询
   - 使用populate填充关联数据
   - 使用skip()和limit()实现分页
   - 使用sort()排序（按创建时间倒序）

④ 后端统计总数：
   - 使用countDocuments()统计符合条件的总数

⑤ 后端返回响应：
   - 返回动物列表和分页信息

⑥ 前端渲染动物列表

**（3）点赞收藏详细设计**

点赞收藏的详细设计如下：

① 用户点击点赞/收藏按钮

② 前端发送POST请求到后端API

③ 后端验证用户身份

④ 后端查询动物信息

⑤ 后端检查用户是否已点赞/收藏：
   - 检查likes/favorites数组中是否包含用户ID

⑥ 如果已点赞/收藏：
   - 从数组中移除用户ID（取消操作）
   - 设置isLiked/isFavorited=false

⑦ 如果未点赞/收藏：
   - 将用户ID添加到数组（执行操作）
   - 设置isLiked/isFavorited=true

⑧ 后端保存到MongoDB

⑨ 后端返回响应，前端更新UI显示

### 4.6.3 领养管理模块详细设计

**（1）领养申请提交详细设计**

领养申请提交的详细设计如下：

① 领养人浏览动物，选择要领养的动物

② 前端显示领养申请表单

③ 领养人填写申请信息：
   - 个人资料（真实姓名、电话、地址等）
   - 领养动机

④ 前端发送申请请求到后端API

⑤ 后端验证用户身份：
   - 检查是否已登录
   - 检查用户类型是否为"领养人"

⑥ 后端查询动物信息：
   - 根据动物ID查询
   - 检查动物是否存在
   - 检查动物状态是否为"可领养"

⑦ 后端检查是否已申请：
   - 检查adoptionApplications数组中是否已有该用户的申请
   - 如果已申请，返回错误

⑧ 后端创建申请记录：
   - 添加到adoptionApplications数组
   - 设置申请状态为"pending"
   - 记录申请时间

⑨ 后端创建历史记录：
   - 添加到history数组
   - type: '领养申请'

⑩ 后端保存到MongoDB

⑪ 后端返回响应，前端显示申请成功提示

**（2）申请审核详细设计**

申请审核的详细设计如下：

① 救助组织登录系统，进入"我的动物管理"页面

② 前端查询该组织发布的所有动物

③ 救助组织选择有申请的动物，查看申请列表

④ 前端显示申请列表，包含：
   - 申请人信息
   - 申请时间
   - 申请状态
   - 领养动机

⑤ 救助组织选择申请，查看详细信息

⑥ 救助组织决定审核结果：
   - 如果通过：更新申请状态为"approved"
   - 如果拒绝：更新申请状态为"rejected"

⑦ 如果确认领养（选择最终领养人）：
   - 更新申请状态为"approved"
   - 更新动物状态为"已领养"
   - 设置adopter为申请人ID
   - 将其他申请状态更新为"rejected"
   - 创建历史记录（type: '领养成功'）

⑧ 后端保存到MongoDB

⑨ 后端返回响应，前端更新显示

### 4.6.4 捐赠管理模块详细设计

**（1）项目创建详细设计**

项目创建的详细设计如下：

① 救助组织登录系统，进入项目发布页面

② 前端显示项目创建表单

③ 救助组织填写项目信息：
   - 项目名称
   - 项目描述
   - 项目类型
   - 目标金额
   - 项目图片

④ 前端发送创建请求到后端API

⑤ 后端验证用户身份：
   - 检查是否已登录
   - 检查用户类型是否为"救助组织"

⑥ 后端使用express-validator验证数据：
   - 验证必填字段
   - 验证金额格式

⑦ 后端创建Project对象：
   - 设置项目信息
   - 设置创建者ID（req.user._id）
   - 设置currentAmount=0
   - 设置status="进行中"

⑧ 后端保存到MongoDB

⑨ 后端返回响应，前端显示创建成功提示

**（2）捐赠详细设计**

捐赠的详细设计如下：

① 捐赠者浏览项目列表，选择要捐赠的项目

② 前端显示项目详情和捐赠表单

③ 捐赠者填写捐赠信息：
   - 捐赠金额
   - 支付方式
   - 捐赠留言
   - 是否匿名

④ 前端发送捐赠请求到后端API

⑤ 后端验证用户身份（已登录用户）

⑥ 后端使用express-validator验证数据：
   - 验证金额格式
   - 验证支付方式

⑦ 后端查询项目信息：
   - 检查项目是否存在
   - 检查项目状态

⑧ 后端创建Donation对象：
   - 设置捐赠信息
   - 关联捐赠者ID
   - 关联项目ID
   - 生成交易哈希（模拟）

⑨ 后端更新项目金额：
   - 增加currentAmount
   - 检查是否达到targetAmount
   - 如果达到，更新status="已完成"

⑩ 后端保存到MongoDB（捐赠记录和项目）

⑪ 后端返回响应，前端显示捐赠成功提示

### 4.6.5 区块链模块详细设计

**（1）NFT铸造详细设计**

NFT铸造的详细设计如下：

① 救助组织发布动物信息时，可选择是否铸造NFT

② 如果选择铸造NFT，前端发送NFT铸造请求

③ 后端调用区块链服务：
   - 生成NFT元数据（包含动物基本信息）
   - 调用mintAnimalNFT函数（模拟）
   - 生成Token ID
   - 生成合约地址
   - 生成交易哈希

④ 后端更新动物记录：
   - 保存NFT信息到nft字段
   - 包括tokenId, contractAddress, metadataURI, txHash

⑤ 后端保存到MongoDB

⑥ 后端返回响应，前端显示NFT铸造成功

**（2）交易记录详细设计**

交易记录的详细设计如下：

① 系统在关键操作时自动记录交易

② 后端调用区块链服务生成交易哈希：
   - 领养申请：调用recordAdoptionApplication
   - 领养成功：调用recordAdoptionSuccess
   - 捐赠：调用recordDonation

③ 后端将交易哈希保存到相应记录：
   - 动物记录的history数组中的tx字段
   - 捐赠记录的txHash字段

④ 后端保存到MongoDB

**（3）数据验证详细设计**

数据验证的详细设计如下：

① 用户查看动物详情时，前端显示区块链信息

② 前端可以查询区块链验证数据：
   - 显示NFT信息（Token ID、合约地址）
   - 显示交易哈希
   - 提供区块链浏览器链接（未来扩展）

③ 后端提供验证接口：
   - 验证NFT所有权
   - 验证交易真实性
   - 验证数据完整性

**（4）区块链服务实现详细设计**

当前区块链服务采用模拟实现，详细设计如下：

① mintAnimalNFT函数：
   - 生成随机Token ID
   - 生成模拟合约地址
   - 生成模拟交易哈希
   - 返回NFT信息

② recordAdoptionApplication函数：
   - 生成模拟交易哈希
   - 返回交易哈希

③ recordDonation函数：
   - 生成模拟交易哈希
   - 返回交易哈希

未来可以替换为真实区块链集成：
   - 使用Web3.js或Ethers.js连接以太坊节点
   - 调用已部署的智能合约
   - 使用真实的交易哈希
   - 集成IPFS存储元数据

## 4.7 本章小结

本章详细阐述了基于区块链的动物保护公益与领养平台的系统设计，包括系统架构设计、系统流程设计、功能模块设计、数据库设计、接口设计和详细设计。

**（1）系统架构设计**

系统采用前后端分离的三层架构，前端使用React构建用户界面，后端使用Node.js + Express提供API服务，数据存储采用MongoDB和区块链技术。这种架构设计保证了系统的可扩展性、安全性和性能。

**（2）系统流程设计**

系统流程设计详细描述了动物发布流程、领养申请与审核流程以及捐赠与项目发布流程。每个流程都经过精心设计，确保业务逻辑的完整性和用户体验的流畅性。

**（3）功能模块设计**

功能模块设计将系统划分为用户注册登录模块、动物管理模块、领养管理模块、捐赠管理模块和区块链模块。每个模块职责明确，接口清晰，便于开发和维护。

**（4）数据库设计**

数据库设计基于MongoDB文档数据库，设计了User、Animal、Donation和Project四个主要集合。ER图展示了实体之间的关系，数据表设计详细定义了每个集合的结构和索引。

**（5）接口设计**

接口设计遵循RESTful API规范，详细定义了认证接口、动物管理接口、领养管理接口和捐赠管理接口。每个接口都包含请求格式、响应格式和错误处理。

**（6）详细设计**

详细设计在功能模块设计的基础上，进一步细化各个模块的实现方案，包括数据流、交互逻辑和关键算法。详细设计为后续的系统实现提供了清晰的指导。

通过本章的系统设计，为系统的实现和测试奠定了坚实的基础。下一章将基于本章的设计方案进行系统的具体实现。


